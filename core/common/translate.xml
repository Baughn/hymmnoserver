<?php
	#Set up constants required for processing.
	$EMOTION_VOWELS = 'A|I|U|E|O|N|YA|YI|YU|YE|YO|YN|LYA|LYI|LYU|LYE|LYO|LYN';
	$EMOTION_VOWELS_REGEXP = '('.$EMOTION_VOWELS.')';
	$EMOTION_VOWELS_REGEXP_FULL = '('.$EMOTION_VOWELS.'|\.)?';
	
	#Read all Emotion Verbs from the database.
	$emotion_verbs = array();
	$stmt = $mysql->prepare("SELECT word FROM hymmnos WHERE class = 1");
	$stmt->execute();
	$stmt->store_result();
	$stmt->bind_result($word);
	while($stmt->fetch()){
		#Store the Emotion Verb, the number of Emotion Vowels, and a regexp version.
		array_push($emotion_verbs, array('/^'.str_replace('.', $EMOTION_VOWELS_REGEXP_FULL, $word).'(eh)?$/', substr_count($word, '.'), $word));
	}
	$stmt->free_result();
	$stmt->close();
	
	#Read the definition of every provided word and construct the displayable Hymmnos string.
	$word_list = array();
	for($i = 0; $i < count($words); $i++){
		$word = readWord($words[$i]);
		$words[$i] = $word;
		array_push($word_list, decorateWord($word[0], $word[3], $word[5], false));
	}
	$word_string = implode(" ", $word_list);
	$word_list = NULL;
	
	#Read a word from the database; Emotion Verbs and Emotion Vowel-prefixed words are detected.
	function readWord($word){
		$emotion_verb = processEmotionVerb($word);
		if($emotion_verb != NULL){
			return $emotion_verb;
		}
		$emotion_word = processEmotionWord($word);
		if($emotion_word != NULL){
			return $emotion_word;
		}
		return queryWord($word);
	}
	
	#Read a word from the database.
	#Return format: [word, english, kana, class, dialect, decorations]
	function queryWord($word){
		$result = NULL;
		
		global $mysql;
		$stmt = $mysql->prepare("SELECT word, meaning_english, kana, class, school FROM hymmnos WHERE word = ? ORDER BY school ASC LIMIT 1");
		$stmt->bind_param("s", $word);
		$stmt->execute();
		$stmt->store_result();
		if($stmt->num_rows > 0){
			$stmt->bind_result($r_word, $english, $kana, $class, $dialect);
			$stmt->fetch();
			$result = array($r_word, $english, $kana, $class, $dialect, NULL);
		}else{
			$result = array($word, NULL, NULL, 0, 0, NULL);
		}
		$stmt->free_result();
		$stmt->close();
		
		return $result;
	}
	
	#Determine whether a word is an Emotion Verb; if so, read it from the database.
	#Return format: [word, english, kana, class, dialect, decorations] | NULL
	function processEmotionVerb($word){
		global $emotion_verbs;
		
		foreach($emotion_verbs as $emotion_verb){
			if(preg_match($emotion_verb[0], $word, $matches)){#Match found.
				$d_word = queryWord($emotion_verb[2]);
				if($d_word[3] > 0){#Match found.
					if(count($matches) - 1 <= $emotion_verb[1]){#Work around a permanent PHP bug.
						for($i = $emotion_verb[1] - count($matches); $i > -1; $i--){
							array_push($matches, '.');
						}
						array_push($matches, ''); 
					}
					$decorations = array();
					foreach(array_slice($matches, 1, -1) as $decoration){
						if($decoration == NULL){
							array_push($decorations, '.');
						}else{
							array_push($decorations, $decoration);
						}
					}
					array_push($decorations, $matches[count($matches) - 1]);
					$d_word[5] = $decorations;
					return $d_word;
				}
			}
		}
		return NULL;
	}
	
	#Determine whether a word is an Emotion Vowel-prefixed word; if so, read it from the database.
	#Return format: [word, english, kana, class, dialect, decorations] | NULL
	function processEmotionWord($word){
		global $EMOTION_VOWELS_REGEXP;
		
		if(preg_match("/^$EMOTION_VOWELS_REGEXP(.+)$/", $word, $matches)){
			$d_word = queryWord($matches[2]);
			if($d_word[3] > 0){#Match found.
				$d_word[5] = array($matches[1]);
				return $d_word;
			}
		}
		return NULL;
	}
	
	#Insert Emotion Vowels or blanks into Emotion Verbs or prefix other words.
	function decorateWord($word, $class, $decorations, $colour){
		if($decorations == NULL){
			return $word;
		}
		
		if($class == 1){#Emotion Verb
			$result = '';
			$chunks = split('\.', $word);
			$i = 0;
			foreach(array_slice($decorations, 0, -1) as $vowel){
				$result = $result.$chunks[$i];
				if($colour){
					$result = $result."<span style=\"color: yellow;\">".$vowel."</span>";
				}else{
					$result = $result.$vowel;
				}
				$i++;
			}
			if($colour){
				return $result."<span style=\"color: magenta;\">".$decorations[count($decorations) - 1]."</span>";
			}else{
				return $result.$decorations[count($decorations) - 1];
			}
		}
		
		global $NOUNS;
		global $ADJECTIVES;
		if(in_array($class, $NOUNS) || in_array($class, $ADJECTIVES)){#noun/adj
			if($colour){
				return "<span style=\"color: yellow;\">".$decorations[0]."</span>".$word;
			}else{
				return $decorations[0].$word;
			}
		}
	}
	
	#Renders a single word in the output table.
	function renderWord($word){
		global $SYNTAX_CLASS;
		
		list($l_word, $english, $kana, $class, $dialect, $decorations) = $word;
		$base_word = htmlspecialchars($l_word);
		if($class == 0){
			$english = '???';
			$kana = '???';
		}else{
			if($decorations != NULL){
				$l_word = htmlspecialchars(decorateWord($l_word, $class, $decorations, true));
			}
			$l_word = "<a href=\"javascript:popUpWord('$base_word', $dialect)\" style=\"color: white;\">".$l_word."</a>";
		}
		
		echo "<tr>";
			echo "<td class=\"word-header-$class\" style=\"width: 17%;\">$l_word</td>";
			echo "<td class=\"word-header-$class\" style=\"width: 14%;\">$SYNTAX_CLASS[$class]</td>";
			echo "<td class=\"word-header-$class\" style=\"width: 50%;\">$english</td>";
			echo "<td class=\"word-header-$class\" style=\"width: 19%;\">$kana</td>";
		echo "</tr>";
	}
	
	#Processes a list of words, rendering everything provided.
	function renderWords($words){
		foreach($words as $word){
			renderWord($word);
		}
	}
?>
<table style="border-collapse: collapse; border: 1px solid black; width: 640px;">
	<tr>
		<td style="color: darkblue; text-align: center; background: lightgrey;">
			<div style="font-family: hymmnos; font-size: 24pt;">
				<?php echo $word_string; ?>
			</div>
			<div style="font-size: 18pt;">
				<?php echo $word_string; ?>
			</div>
		</td>
	</tr>
	<tr>
		<td style="background: grey; color: white;">
			<table style="width: 100%;">
				<?php renderWords($words); ?>
			</table>
		</td>
	</tr>
	<tr>
		<td style="color: darkblue; text-align: center; background: lightgrey; font-size: 0.7em;">
			<?php
				$query_encode = urlencode($query);
				echo "If this is a sentence, you can <a href=\"/hymmnoserver/grammar.pyp?query=$query_encode\">inspect its structure</a>.";
			?>
		</td>
	</tr>
</table>
<hr/>
<div style="color: grey; font-size: 0.6em;">
	<p>
		There is no difference between singular and plural nouns, unless implied by context:
		&quot;wart&quot;, for example, can mean either &quot;word&quot; or &quot;words&quot;,
		depending on which is more appropriate.<br/>
	</p>
	<p>
		The presented kana does not take Emotion Vowels into consideration.
	</p>
</div>

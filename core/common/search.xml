<?php
	function renderMatches($qualifier, $quality, $type){
		global $mysql;
		global $SCHOOL;
		global $SYNTAX_CLASS_FULL;
		
		$stmt = $mysql->prepare("SELECT word, meaning_english, meaning_japanese, kana, school, romaji, description, class FROM hymmnos WHERE $qualifier LIKE ? ORDER BY school ASC");
		$stmt->bind_param("s", $quality);
		$stmt->execute();
		$stmt->store_result();
		
		$matched = $stmt->num_rows > 0;
		if($matched){
			$plural = '';
			if($stmt->num_rows != 1){
				$plural = 's';
			}
			echo '<div style="padding-bottom: 10px;">';
			echo "<span style=\"color: red; font-weight: bold;\">$type ($stmt->num_rows record$plural)</span>";
			echo '<div style="padding-left: 13px;">';
				$stmt->bind_result($word, $meaning_english, $meaning_japanese, $kana, $school, $romaji, $description, $class);
				
				while($stmt->fetch()){
					$stmt2 = $mysql->prepare("SELECT destination, destination_school FROM hymmnos_mapping WHERE source = ? AND source_school = ? ORDER BY destination ASC");
					$stmt2->bind_param("si", $word, $school);
					$stmt2->execute();
					$stmt2->store_result();
					
					$links = array();
					$stmt2->bind_result($link, $l_school);
					while($stmt2->fetch()){
						array_push($links, array($link, $l_school));
					}
					
					$stmt2->free_result();
					$stmt2->close();
					
					include 'common/word.xml';
				}
			echo '</div></div>';
		}
		
		$stmt->free_result();
		$stmt->close();
		
		return $matched;
	}
	
	$matches = false;
	$word = $words[0].'%';
	
	$matches = renderMatches("word", $word, "Hymmnos matches", $mysql, $SCHOOL, $SYNTAX_CLASS_FULL) || $matches;
	$matches = renderMatches("meaning_english", '%'.$word, "English matches", $mysql, $SCHOOL, $SYNTAX_CLASS_FULL) || $matches;
	$matches = renderMatches("romaji", $word, "Romaji matches", $mysql, $SCHOOL, $SYNTAX_CLASS_FULL) || $matches;
	if(!$matches){
		$matches = renderMatches("kana", $word, "Kana matches", $mysql, $SCHOOL, $SYNTAX_CLASS_FULL);
	}
	
	if(!$matches){
		echo '<span style="color: red; font-weight: bold;">No matches found</span>';
	}
?>
